// ===========================================
// ORG MAP DRAWFLOW - Interactive Canvas
// Sprint 6 - Fase N: N8N-style org chart
// ===========================================

@use 'dashboard-tokens' as tokens;
@use "sass:color";

// =====================
// RISK LEVEL COLORS
// =====================
$risk-colors: (
    'i': #10b981,
    'ii': #84cc16,
    'iii': #f59e0b,
    'iv': #f97316,
    'v': #ef4444
);

// =====================
// CANVAS CONTAINER
// =====================
.orgmap-canvas {
    position: relative;
    width: 100%;
    height: 500px;
    min-height: 400px;
    border-radius: tokens.$radius-lg;
    border: 1px solid tokens.$dashboard-border;
    overflow: hidden;

    // Grid on container - will be scaled via JS based on zoom
    // CSS custom properties for dynamic grid sizing
    --grid-size: 20px;
    --grid-major: 100px;
    $grid-color: rgba(tokens.$dashboard-secondary, 0.08);
    $grid-color-strong: rgba(tokens.$dashboard-secondary, 0.18);
    background-color: tokens.$dashboard-background;
    background-image:
        linear-gradient(to right, $grid-color 1px, transparent 1px),
        linear-gradient(to bottom, $grid-color 1px, transparent 1px),
        linear-gradient(to right, $grid-color-strong 1px, transparent 1px),
        linear-gradient(to bottom, $grid-color-strong 1px, transparent 1px);
    background-size:
        var(--grid-size) var(--grid-size),
        var(--grid-size) var(--grid-size),
        var(--grid-major) var(--grid-major),
        var(--grid-major) var(--grid-major);

    // Drawflow overrides
    .drawflow {
        width: 100%;
        height: 100%;
        background: transparent;
    }

    &--dragover {
        border-color: tokens.$dashboard-primary;
        background: rgba(tokens.$dashboard-primary, 0.03);

        .drawflow {
            opacity: 0.9;
        }
    }
}

// =====================
// DRAWFLOW NODE OVERRIDES
// =====================
.drawflow-node {
    // Remove default Drawflow node styles
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    min-width: auto !important;
    border-radius: 0 !important;

    // Override Drawflow's default left/right wrapper positioning
    .inputs {
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        display: block;
    }

    .outputs {
        position: absolute;
        bottom: -6px;
        left: 50%;
        top: auto;
        right: auto;
        transform: translateX(-50%);
        width: auto;
        display: block;
    }

    // Connection dots (vertical: input top, output bottom)
    .input,
    .output {
        width: 12px;
        height: 12px;
        background: tokens.$dashboard-primary;
        border: 2px solid tokens.$dashboard-white;
        border-radius: 50%;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        cursor: crosshair;
        transition: transform 0.15s ease, background 0.15s ease;

        &:hover {
            transform: scale(1.4);
            background: color.adjust(tokens.$dashboard-primary, $lightness: -10%);
        }
    }

    .input {
        top: -6px;
        left: 50%;
        transform: translateX(-50%);

        &:hover {
            transform: translateX(-50%) scale(1.4);
        }
    }

    .output {
        bottom: -6px;
        left: 50%;
        top: auto;
        right: auto;
        transform: translateX(-50%);

        &:hover {
            transform: translateX(-50%) scale(1.4);
        }
    }

    &.selected {
        .orgmap-node {
            box-shadow: 0 0 0 2px tokens.$dashboard-primary, tokens.$shadow-lg;
        }
    }
}

// =====================
// CONNECTION LINES (Orthogonal)
// =====================
.drawflow .connection {
    .main-path {
        stroke: tokens.$dashboard-primary;
        stroke-width: 2;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
        transition: stroke 0.2s ease;
    }

    &:hover .main-path {
        stroke: color.adjust(tokens.$dashboard-primary, $lightness: -10%);
        stroke-width: 3;
    }

    // Reroute points
    .point {
        width: 10px;
        height: 10px;
        background: tokens.$dashboard-primary;
        border: 2px solid tokens.$dashboard-white;
        border-radius: 50%;
        cursor: move;
    }
}

// =====================
// CARGO NODE CARD (on canvas)
// =====================
.orgmap-node {
    width: 200px;
    background: tokens.$dashboard-white;
    border-radius: tokens.$radius-lg;
    border: 1px solid tokens.$dashboard-border;
    box-shadow: tokens.$shadow-sm;
    cursor: grab;
    transition: box-shadow 0.2s ease, transform 0.15s ease;
    user-select: none;
    overflow: hidden;

    &:hover {
        box-shadow: tokens.$shadow-md;
        transform: translateY(-1px);
    }

    &:active {
        cursor: grabbing;
        transform: translateY(0);
    }

    &--selected {
        box-shadow: 0 0 0 2px tokens.$dashboard-primary, tokens.$shadow-lg !important;
    }

    // Risk level left border
    @each $level, $color in $risk-colors {
        &--#{$level} {
            border-left: 3px solid $color;

            .orgmap-node__badge--#{$level} {
                background: rgba($color, 0.12);
                color: $color;
            }
        }
    }

    // Header
    &__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        border-bottom: 1px solid tokens.$dashboard-border;
        background: tokens.$dashboard-background;
    }

    &__badge {
        font-size: 1rem;
        font-weight: tokens.$font-semibold;
        padding: 2px 6px;
        border-radius: tokens.$radius-sm;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    &__edit-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        color: tokens.$dashboard-text-light;
        border-radius: tokens.$radius-sm;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease;

        &:hover {
            background: rgba(tokens.$dashboard-primary, 0.1);
            color: tokens.$dashboard-primary;
        }
    }

    // Body
    &__body {
        padding: 10px;
    }

    &__title {
        font-family: tokens.$font-family-title;
        font-size: 1.3rem;
        font-weight: tokens.$font-semibold;
        color: tokens.$dashboard-secondary;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    &__area,
    &__zona {
        font-size: 1.1rem;
        color: tokens.$dashboard-text-light;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    &__area {
        font-weight: tokens.$font-medium;
    }

    // Stats footer
    &__stats {
        display: flex;
        border-top: 1px solid tokens.$dashboard-border;
        background: tokens.$dashboard-background;
    }

    &__stat {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 6px 8px;

        &:not(:last-child) {
            border-right: 1px solid tokens.$dashboard-border;
        }
    }

    &__stat-value {
        font-size: 1.2rem;
        font-weight: tokens.$font-bold;
        color: tokens.$dashboard-secondary;
    }

    &__stat-label {
        font-size: 1rem;
        color: tokens.$dashboard-text-light;
    }
}

// =====================
// PALETTE / DOCK
// =====================
.orgmap-palette {
    margin-top: tokens.$space-4;
    background: tokens.$dashboard-white;
    border-radius: tokens.$radius-lg;
    border: 1px solid tokens.$dashboard-border;
    padding: tokens.$space-4;

    &__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: tokens.$space-3;
    }

    &__title {
        font-family: tokens.$font-family-title;
        font-size: 1.3rem;
        font-weight: tokens.$font-semibold;
        color: tokens.$dashboard-secondary;
    }

    &__hint {
        font-size: 1.1rem;
        color: tokens.$dashboard-text-light;
        font-style: italic;
    }

    &__cards {
        display: flex;
        flex-wrap: wrap;
        gap: tokens.$space-2;
    }

    &__empty {
        padding: tokens.$space-4;
        text-align: center;
        font-size: 1.2rem;
        color: tokens.$dashboard-text-light;
    }
}

// Palette card (compact, draggable)
.orgmap-palette-card {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: tokens.$dashboard-background;
    border: 1px solid tokens.$dashboard-border;
    border-radius: tokens.$radius-full;
    cursor: grab;
    transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
    user-select: none;

    &:hover {
        background: tokens.$dashboard-white;
        box-shadow: tokens.$shadow-sm;
        transform: translateY(-1px);
    }

    &:active,
    &--dragging {
        cursor: grabbing;
        opacity: 0.6;
        transform: scale(0.95);
    }

    &__dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;

        @each $level, $color in $risk-colors {
            &--#{$level} {
                background: $color;
            }
        }
    }

    &__name {
        font-size: 1.2rem;
        font-weight: tokens.$font-medium;
        color: tokens.$dashboard-secondary;
        white-space: nowrap;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
}

// =====================
// ZOOM CONTROLS
// =====================
.orgmap-controls {
    position: absolute;
    top: tokens.$space-3;
    right: tokens.$space-3;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 10;
}

.orgmap-control-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: tokens.$dashboard-white;
    border: 1px solid tokens.$dashboard-border;
    border-radius: tokens.$radius-md;
    cursor: pointer;
    color: tokens.$dashboard-secondary;
    transition: background 0.15s ease, color 0.15s ease;

    &:hover {
        background: tokens.$dashboard-primary;
        color: tokens.$dashboard-white;
        border-color: tokens.$dashboard-primary;
    }

    svg {
        width: 16px;
        height: 16px;
    }
}

// =====================
// RESPONSIVE
// =====================
@include tokens.respond-to('tablet') {
    .orgmap-canvas {
        height: 350px;
        min-height: 300px;
    }

    .orgmap-node {
        width: 170px;

        &__title {
            font-size: 1.2rem;
        }
    }

    .orgmap-palette-card {
        &__name {
            max-width: 100px;
        }
    }
}
