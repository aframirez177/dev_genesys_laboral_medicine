/**
 * diagnosticoSteps.js - Definici√≥n de pasos del wizard SST
 *
 * Define los pasos del wizard para el diagn√≥stico de riesgos laborales
 * Integra con los endpoints de IA creados en Fase 1
 */

import { html } from 'lit-html';
import { cargoState } from '../../state/CargoState.js';
import { GES_CATEGORIES, getCategoryColor } from '../../config/ges-categories.js';
import { SECTORES_ECONOMICOS, getCiudadesSimple } from '../../config/colombia-data.js';

/**
 * Helper: Fetch con manejo de errores
 */
async function fetchIA(endpoint, data = null) {
  try {
    const options = data ? {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    } : { method: 'GET' };

    const response = await fetch(`/api/ia${endpoint}`, options);

    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }

    return await response.json();
  } catch (error) {
    console.error(`Error en endpoint ${endpoint}:`, error);
    return { success: false, error: error.message };
  }
}

/**
 * Helper: Debounce para autocomplete
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// GES_CATEGORIES ahora se importa desde config/ges-categories.js

/**
 * Estado global para almacenar sugerencias de IA durante el wizard
 */
let aiSuggestionsCache = {
  ges: {},
  controls: {}
};

// =================================================================
// PASO 1: BIENVENIDA
// =================================================================

export const welcomeStep = {
  id: 'welcome',
  title: 'Bienvenido al Diagn√≥stico de Riesgos Laborales',

  render: () => html`
    <h2>üëã ¬°Bienvenido al Diagn√≥stico de Riesgos Laborales!</h2>
    <p>
      Este asistente te guiar√° paso a paso para crear la matriz de riesgos profesionales
      de tu empresa seg√∫n la metodolog√≠a GTC 45.
    </p>

    <div class="wizard-hint">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
      </svg>
      <span>
        Este proceso tomar√° aproximadamente <strong>5-10 minutos</strong> dependiendo
        del n√∫mero de cargos a evaluar.
      </span>
    </div>

    <div class="wizard-options">
      <div class="wizard-option" style="text-align: left;">
        <div class="option-icon">‚ú®</div>
        <div class="option-label">Sugerencias Inteligentes</div>
        <div class="option-description">
          Recibir√°s recomendaciones autom√°ticas basadas en tu sector y cargos
        </div>
      </div>

      <div class="wizard-option" style="text-align: left;">
        <div class="option-icon">üíæ</div>
        <div class="option-label">Auto-guardado</div>
        <div class="option-description">
          Tu progreso se guarda autom√°ticamente cada 5 segundos
        </div>
      </div>

      <div class="wizard-option" style="text-align: left;">
        <div class="option-icon">üìä</div>
        <div class="option-label">Documentos Profesionales</div>
        <div class="option-description">
          Al finalizar obtendr√°s matriz, profesiograma y perfiles de cargo
        </div>
      </div>
    </div>
  `,

  validate: () => ({ isValid: true, errors: [] })
};

// =================================================================
// PASO 2: INFORMACI√ìN DE LA EMPRESA
// =================================================================

export const empresaStep = {
  id: 'empresa',
  title: 'Informaci√≥n de la Empresa',

  render: (data = {}) => html`
    <h2>üìã Informaci√≥n de la Empresa</h2>
    <p>Cu√©ntanos sobre tu empresa para personalizar el diagn√≥stico.</p>

    <div style="display: flex; flex-direction: column; gap: 2rem; margin-top: 3rem;">
      <div>
        <label for="empresa-nombre" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
          Nombre de la empresa *
        </label>
        <input
          type="text"
          id="empresa-nombre"
          name="nombre"
          placeholder="Ej: ACME Corporation S.A.S"
          value="${data.nombre || ''}"
          required
        />
      </div>

      <div>
        <label for="empresa-nit" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
          NIT *
        </label>
        <input
          type="text"
          id="empresa-nit"
          name="nit"
          placeholder="Ej: 900123456-7"
          value="${data.nit || ''}"
          required
        />
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
          <label for="empresa-sector" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Sector Econ√≥mico *
          </label>
          <select id="empresa-sector" name="sector" required>
            <option value="">Seleccione el sector...</option>
            ${SECTORES_ECONOMICOS.map(sector => html`
              <option value="${sector.value}" ?selected=${data.sector === sector.value}>
                ${sector.label}
              </option>
            `)}
          </select>
        </div>

        <div>
          <label for="empresa-ciudad" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Ciudad *
          </label>
          <input
            type="text"
            id="empresa-ciudad"
            name="ciudad"
            placeholder="Ej: Bogot√°"
            value="${data.ciudad || ''}"
            required
            list="ciudades-list"
          />
          <datalist id="ciudades-list">
            ${getCiudadesSimple().map(ciudad => `<option value="${ciudad}">`).join('')}
          </datalist>
        </div>
      </div>
    </div>

    <div class="wizard-hint" style="margin-top: 3rem;">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
      </svg>
      <span>
        Esta informaci√≥n aparecer√° en todos los documentos generados.
      </span>
    </div>
  `,

  validate: (data) => {
    const errors = [];

    if (!data.nombre || data.nombre.trim().length < 3) {
      errors.push({ field: 'nombre', message: 'El nombre de la empresa debe tener al menos 3 caracteres' });
    }

    if (!data.nit || data.nit.trim().length < 5) {
      errors.push({ field: 'nit', message: 'El NIT debe tener al menos 5 caracteres' });
    }

    if (!data.sector) {
      errors.push({ field: 'sector', message: 'Debe seleccionar un sector' });
    }

    if (!data.ciudad || data.ciudad.trim().length < 2) {
      errors.push({ field: 'ciudad', message: 'Debe ingresar una ciudad' });
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  },

  onEnter: function(wizardData) {
    // Si ya hay datos en cargoState, pre-llenar
    const stateData = cargoState.getState();
    if (stateData.empresa && stateData.empresa.nombre) {
      // Ya hay datos, no hacer nada (el render usar√° estos datos)
    }
  }
};

// =================================================================
// PASO 3: N√öMERO DE CARGOS
// =================================================================

export const numCargosStep = {
  id: 'numCargos',
  title: '¬øCu√°ntos cargos evaluar√°s?',

  render: (data = {}) => html`
    <h2>üë• ¬øCu√°ntos cargos diferentes evaluar√°s?</h2>
    <p>Indica el n√∫mero de posiciones o cargos distintos que tiene tu empresa.</p>

    <div style="margin-top: 4rem;">
      <input
        type="number"
        id="num-cargos"
        name="numCargos"
        placeholder="Ej: 5"
        min="1"
        max="50"
        value="${data.numCargos || ''}"
        required
        style="text-align: center; font-size: 3.6rem; font-weight: 700;"
      />
    </div>

    <div class="wizard-hint" style="margin-top: 3rem;">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
      </svg>
      <span>
        Por ejemplo: Operario, Supervisor, Gerente, Contador, etc.
        Si tienes 10 operarios, cuenta solo 1 cargo (Operario).
      </span>
    </div>

    <div class="wizard-options" style="margin-top: 3rem;">
      <div class="wizard-option" data-num="2">
        <div class="option-icon">üè¢</div>
        <div class="option-label" style="line-height: 1.6;">
          <span class="green">Peque√±as empresas</span><br>
          <span style="font-size: 1.3rem; font-weight: 400;">tienen entre 1 y 3 cargos</span>
        </div>
      </div>

      <div class="wizard-option" data-num="7">
        <div class="option-icon">üè≠</div>
        <div class="option-label" style="line-height: 1.6;">
          <span class="green">Medianas empresas</span><br>
          <span style="font-size: 1.3rem; font-weight: 400;">tienen entre 4 y 10 cargos</span>
        </div>
      </div>

      <div class="wizard-option" data-num="15">
        <div class="option-icon">üèôÔ∏è</div>
        <div class="option-label" style="line-height: 1.6;">
          <span class="green">Grandes empresas</span><br>
          <span style="font-size: 1.3rem; font-weight: 400;">tienen 11 o m√°s cargos</span>
        </div>
      </div>
    </div>
  `,

  validate: (data) => {
    const errors = [];
    const num = parseInt(data.numCargos, 10);

    if (!num || num < 1) {
      errors.push({ field: 'numCargos', message: 'Debe indicar al menos 1 cargo' });
    }

    if (num > 50) {
      errors.push({ field: 'numCargos', message: 'El m√°ximo de cargos soportado es 50. Contacta con soporte para empresas grandes.' });
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  },

  onEnter: function() {
    // Agregar event listeners para los quick-select buttons
    setTimeout(() => {
      const options = document.querySelectorAll('.wizard-option[data-num]');
      const input = document.getElementById('num-cargos');

      options.forEach(option => {
        option.addEventListener('click', () => {
          const num = option.dataset.num;
          input.value = num;

          // Remover clase selected de todas
          options.forEach(opt => opt.classList.remove('selected'));
          // Agregar a la clickeada
          option.classList.add('selected');
        });
      });
    }, 100);
  }
};

// =================================================================
// PASO 4: INFORMACI√ìN DE CARGO (se repite para cada cargo)
// =================================================================

export function createCargoInfoStep(cargoIndex, totalCargos) {
  return {
    id: `cargo-info-${cargoIndex}`,
    title: `Cargo ${cargoIndex + 1} de ${totalCargos}`,

    render: (data = {}) => html`
      <h2>üè¢ Cargo ${cargoIndex + 1} de ${totalCargos}</h2>
      <p>Ingresa los detalles del cargo que deseas evaluar.</p>

      <div style="display: flex; flex-direction: column; gap: 2rem; margin-top: 3rem;">
        <div>
          <label for="cargo-name" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Nombre del cargo *
          </label>
          <input
            type="text"
            id="cargo-name"
            name="cargoName"
            placeholder="Ej: Operario de producci√≥n"
            value="${data.cargoName || ''}"
            required
            autocomplete="off"
          />
          <div id="autocomplete-suggestions" class="ai-suggestions" style="display: none; margin-top: 1rem;">
            <!-- Sugerencias de autocompletado aparecer√°n aqu√≠ -->
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <div>
            <label for="cargo-area" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
              √Årea *
            </label>
            <input
              type="text"
              id="cargo-area"
              name="area"
              placeholder="Ej: Producci√≥n"
              value="${data.area || ''}"
              required
            />
          </div>

          <div>
            <label for="cargo-zona" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
              Zona *
            </label>
            <input
              type="text"
              id="cargo-zona"
              name="zona"
              placeholder="Ej: Planta 1, Oficina Principal"
              value="${data.zona || ''}"
              required
            />
          </div>
        </div>

        <div>
          <label for="cargo-num-trabajadores" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            N¬∞ de trabajadores *
          </label>
          <input
            type="number"
            id="cargo-num-trabajadores"
            name="numTrabajadores"
            placeholder="Ej: 15"
            min="1"
            value="${data.numTrabajadores || ''}"
            required
            style="max-width: 200px;"
          />
        </div>

        <div>
          <label for="cargo-descripcion-tareas" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Descripci√≥n de tareas *
          </label>
          <textarea
            id="cargo-descripcion-tareas"
            name="descripcionTareas"
            placeholder="Describe las principales tareas y responsabilidades del cargo (m√≠nimo 20 caracteres)"
            rows="4"
            required
          >${data.descripcionTareas || ''}</textarea>
          <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
            Ejemplo: "Opera m√°quinas de corte, realiza inspecci√≥n de calidad, mantiene el √°rea de trabajo limpia y ordenada"
          </p>
        </div>
      </div>

      <div class="wizard-hint" style="margin-top: 3rem;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
        </svg>
        <span>
          Comienza a escribir el nombre del cargo y recibir√°s sugerencias autom√°ticas.
        </span>
      </div>
    `,

    validate: (data) => {
      const errors = [];

      if (!data.cargoName || data.cargoName.trim().length < 3) {
        errors.push({ field: 'cargoName', message: 'El nombre del cargo debe tener al menos 3 caracteres' });
      }

      if (!data.area || data.area.trim().length < 2) {
        errors.push({ field: 'area', message: 'El √°rea debe tener al menos 2 caracteres' });
      }

      if (!data.zona || data.zona.trim().length < 2) {
        errors.push({ field: 'zona', message: 'La zona debe tener al menos 2 caracteres' });
      }

      const numTrabajadores = parseInt(data.numTrabajadores, 10);
      if (!numTrabajadores || numTrabajadores < 1) {
        errors.push({ field: 'numTrabajadores', message: 'Debe haber al menos 1 trabajador' });
      }

      if (!data.descripcionTareas || data.descripcionTareas.trim().length < 20) {
        errors.push({ field: 'descripcionTareas', message: 'La descripci√≥n de tareas debe tener al menos 20 caracteres' });
      }

      return {
        isValid: errors.length === 0,
        errors
      };
    },

    onEnter: function() {
      // Setup autocomplete
      setTimeout(() => {
        const input = document.getElementById('cargo-name');
        const suggestionsContainer = document.getElementById('autocomplete-suggestions');

        if (!input || !suggestionsContainer) return;

        const debouncedAutocomplete = debounce(async (query) => {
          if (query.length < 3) {
            suggestionsContainer.style.display = 'none';
            return;
          }

          const result = await fetchIA(`/autocomplete-cargo?q=${encodeURIComponent(query)}`);

          if (result.success && result.suggestions && result.suggestions.length > 0) {
            suggestionsContainer.innerHTML = `
              <p style="font-size: 1.4rem; font-weight: 600; margin-bottom: 1rem;">
                üí° Sugerencias:
              </p>
              ${result.suggestions.map(s => `
                <button
                  type="button"
                  class="suggestion-chip"
                  data-cargo="${s.cargo}"
                  style="margin: 0.5rem; cursor: pointer;"
                >
                  ${s.cargo}
                  <span class="confidence">${s.frequency}%</span>
                </button>
              `).join('')}
            `;
            suggestionsContainer.style.display = 'block';

            // Event listeners para chips
            suggestionsContainer.querySelectorAll('.suggestion-chip').forEach(chip => {
              chip.addEventListener('click', () => {
                input.value = chip.dataset.cargo;
                suggestionsContainer.style.display = 'none';
              });
            });
          } else {
            suggestionsContainer.style.display = 'none';
          }
        }, 500);

        input.addEventListener('input', (e) => {
          debouncedAutocomplete(e.target.value);
        });
      }, 100);
    }
  };
}

// =================================================================
// PASO 5: TOGGLES ESPECIALES (caracter√≠sticas cr√≠ticas del cargo)
// =================================================================

export function createTogglesEspecialesStep(cargoIndex, totalCargos, cargoName) {
  return {
    id: `toggles-especiales-${cargoIndex}`,
    title: `Caracter√≠sticas especiales: ${cargoName}`,

    render: (data = {}) => html`
      <h2>‚ö†Ô∏è Caracter√≠sticas Especiales del Cargo</h2>
      <p>
        Indica si este cargo tiene alguna de las siguientes caracter√≠sticas especiales
        que requieren evaluaci√≥n y controles adicionales seg√∫n la normatividad colombiana.
      </p>

      <div style="display: flex; flex-direction: column; gap: 2.5rem; margin-top: 3rem;">
        <!-- Tareas Rutinarias -->
        <label
          class="wizard-option toggle-option ${data.tareasRutinarias ? 'selected' : ''}"
          style="padding: 2rem; cursor: pointer; text-align: left; display: flex; align-items: start; gap: 1.5rem; border: 2px solid #e0e0e0;"
        >
          <input
            type="checkbox"
            name="tareasRutinarias"
            ?checked=${data.tareasRutinarias || false}
            style="width: 24px; height: 24px; cursor: pointer; margin-top: 0.3rem; flex-shrink: 0;"
          />
          <div style="flex: 1;">
            <div style="font-size: 1.6rem; font-weight: 600; color: #383d47; margin-bottom: 0.8rem;">
              üîÑ Tareas Rutinarias
            </div>
            <div style="font-size: 1.4rem; color: #666; line-height: 1.6;">
              El cargo realiza actividades repetitivas o programadas de manera regular.
              Esto puede implicar mayor riesgo biomec√°nico y psicosocial por monoton√≠a.
            </div>
          </div>
        </label>

        <!-- Manipula Alimentos -->
        <label
          class="wizard-option toggle-option ${data.manipulaAlimentos ? 'selected' : ''}"
          style="padding: 2rem; cursor: pointer; text-align: left; display: flex; align-items: start; gap: 1.5rem; border: 2px solid #e0e0e0;"
        >
          <input
            type="checkbox"
            name="manipulaAlimentos"
            ?checked=${data.manipulaAlimentos || false}
            style="width: 24px; height: 24px; cursor: pointer; margin-top: 0.3rem; flex-shrink: 0;"
          />
          <div style="flex: 1;">
            <div style="font-size: 1.6rem; font-weight: 600; color: #383d47; margin-bottom: 0.8rem;">
              üçΩÔ∏è Manipulaci√≥n de Alimentos
            </div>
            <div style="font-size: 1.4rem; color: #666; line-height: 1.6;">
              <strong>Res. 2674/2013:</strong> Requiere certificaci√≥n sanitaria, ex√°menes m√©dicos espec√≠ficos
              y cumplimiento de BPM (Buenas Pr√°cticas de Manufactura).
            </div>
          </div>
        </label>

        <!-- Trabajo en Alturas -->
        <label
          class="wizard-option toggle-option ${data.trabajaAlturas ? 'selected' : ''}"
          style="padding: 2rem; cursor: pointer; text-align: left; display: flex; align-items: start; gap: 1.5rem; border: 2px solid #ff9800;"
        >
          <input
            type="checkbox"
            name="trabajaAlturas"
            ?checked=${data.trabajaAlturas || false}
            style="width: 24px; height: 24px; cursor: pointer; margin-top: 0.3rem; flex-shrink: 0;"
          />
          <div style="flex: 1;">
            <div style="font-size: 1.6rem; font-weight: 600; color: #ff9800; margin-bottom: 0.8rem;">
              ‚õ∞Ô∏è Trabajo en Alturas (CR√çTICO)
            </div>
            <div style="font-size: 1.4rem; color: #666; line-height: 1.6;">
              <strong>Res. 1409/2012:</strong> Trabajo a partir de 1.5 metros de altura.
              Requiere certificaci√≥n obligatoria, ex√°menes m√©dicos anuales, sistemas de protecci√≥n contra ca√≠das
              y programa de protecci√≥n contra ca√≠das (SG-SST).
            </div>
          </div>
        </label>

        <!-- Espacios Confinados -->
        <label
          class="wizard-option toggle-option ${data.trabajaEspaciosConfinados ? 'selected' : ''}"
          style="padding: 2rem; cursor: pointer; text-align: left; display: flex; align-items: start; gap: 1.5rem; border: 2px solid #f44336;"
        >
          <input
            type="checkbox"
            name="trabajaEspaciosConfinados"
            ?checked=${data.trabajaEspaciosConfinados || false}
            style="width: 24px; height: 24px; cursor: pointer; margin-top: 0.3rem; flex-shrink: 0;"
          />
          <div style="flex: 1;">
            <div style="font-size: 1.6rem; font-weight: 600; color: #f44336; margin-bottom: 0.8rem;">
              üö™ Espacios Confinados (CR√çTICO)
            </div>
            <div style="font-size: 1.4rem; color: #666; line-height: 1.6;">
              <strong>Res. 1409/2012:</strong> Espacios con entradas/salidas limitadas y ventilaci√≥n desfavorable.
              Requiere permiso de trabajo, monitoreo atmosf√©rico, entrenamiento especializado y plan de rescate.
            </div>
          </div>
        </label>

        <!-- Conduce Veh√≠culo -->
        <label
          class="wizard-option toggle-option ${data.conduceVehiculo ? 'selected' : ''}"
          style="padding: 2rem; cursor: pointer; text-align: left; display: flex; align-items: start; gap: 1.5rem; border: 2px solid #e0e0e0;"
        >
          <input
            type="checkbox"
            name="conduceVehiculo"
            ?checked=${data.conduceVehiculo || false}
            style="width: 24px; height: 24px; cursor: pointer; margin-top: 0.3rem; flex-shrink: 0;"
          />
          <div style="flex: 1;">
            <div style="font-size: 1.6rem; font-weight: 600; color: #383d47; margin-bottom: 0.8rem;">
              üöó Conduce Veh√≠culos
            </div>
            <div style="font-size: 1.4rem; color: #666; line-height: 1.6;">
              <strong>Res. 1565/2014 (PESV):</strong> Requiere licencia de conducci√≥n vigente,
              ex√°menes m√©dicos espec√≠ficos (visiometr√≠a, audiometr√≠a), capacitaci√≥n en conducci√≥n defensiva
              y seguridad vial.
            </div>
          </div>
        </label>
      </div>

      <div class="wizard-hint" style="margin-top: 3rem;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
        </svg>
        <span>
          Estas caracter√≠sticas determinan requisitos legales espec√≠ficos y controles adicionales
          en el profesiograma y perfil del cargo.
        </span>
      </div>
    `,

    getData: () => {
      return {
        tareasRutinarias: document.querySelector('input[name="tareasRutinarias"]')?.checked || false,
        manipulaAlimentos: document.querySelector('input[name="manipulaAlimentos"]')?.checked || false,
        trabajaAlturas: document.querySelector('input[name="trabajaAlturas"]')?.checked || false,
        trabajaEspaciosConfinados: document.querySelector('input[name="trabajaEspaciosConfinados"]')?.checked || false,
        conduceVehiculo: document.querySelector('input[name="conduceVehiculo"]')?.checked || false
      };
    },

    validate: () => {
      // No validation required - all toggles are optional
      return { isValid: true, errors: [] };
    },

    onEnter: function() {
      // Add event listeners to toggle visual state
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('.toggle-option input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            const label = cb.closest('.toggle-option');
            if (label) {
              label.classList.toggle('selected', cb.checked);
            }
          });
        });
      }, 100);
    }
  };
}

// =================================================================
// PASO 6: SELECCI√ìN DE GES (se repite para cada cargo)
// =================================================================

export function createGESSelectionStep(cargoIndex, totalCargos, cargoName) {
  return {
    id: `ges-selection-${cargoIndex}`,
    title: `Riesgos del cargo: ${cargoName}`,

    render: (data = {}) => {
      const selectedGES = data.gesSeleccionados || [];

      return html`
        <h2>‚ö†Ô∏è Selecciona los riesgos para "${cargoName}"</h2>
        <p>Indica qu√© riesgos est√°n presentes en este cargo seg√∫n la GTC 45.</p>

        <!-- Sugerencias de IA -->
        <div id="ai-ges-suggestions" style="display: none;" class="ai-suggestions">
          <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">
            ‚ú® Sugerencias basadas en el cargo:
          </p>
          <div id="ai-ges-chips"></div>
        </div>

        <!-- Selecci√≥n manual por categor√≠as -->
        <div style="margin-top: 3rem;">
          ${Object.entries(GES_CATEGORIES).map(([category, categoryData]) => {
            const categoryColor = categoryData.color;
            const items = categoryData.items;

            return html`
              <div style="margin-bottom: 3rem;">
                <h3 style="font-size: 1.8rem; font-weight: 600; color: ${categoryColor}; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                  <span style="display: inline-block; width: 4px; height: 2.4rem; background: ${categoryColor}; border-radius: 2px;"></span>
                  ${category}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                  ${items.map(item => {
                    const isSelected = selectedGES.some(g => g.riesgo === category && g.ges === item);
                    return html`
                      <label
                        class="wizard-option ${isSelected ? 'selected' : ''}"
                        style="padding: 1.5rem; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 1rem; border-left: 3px solid ${categoryColor};"
                      >
                        <input
                          type="checkbox"
                          name="ges-${category}"
                          value="${item}"
                          data-category="${category}"
                          ?checked=${isSelected}
                          style="width: 18px; height: 18px; cursor: pointer;"
                        />
                        <span style="font-size: 1.4rem;">${item}</span>
                      </label>
                    `;
                  })}
                </div>
              </div>
            `;
          })}
        </div>

        <div class="wizard-hint" style="margin-top: 3rem;">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
          </svg>
          <span>
            Selecciona al menos un riesgo. Puedes seleccionar varios si aplican al cargo.
          </span>
        </div>
      `;
    },

    getData: async () => {
      const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="ges-"]:checked');
      const gesSeleccionados = [];

      checkboxes.forEach(cb => {
        gesSeleccionados.push({
          riesgo: cb.dataset.category,
          ges: cb.value,
          controles: {
            fuente: '',
            medio: '',
            individuo: ''
          }
        });
      });

      return { gesSeleccionados };
    },

    validate: (data) => {
      const errors = [];

      if (!data.gesSeleccionados || data.gesSeleccionados.length === 0) {
        errors.push({
          field: 'gesSeleccionados',
          message: 'Debe seleccionar al menos un riesgo para este cargo'
        });
      }

      return {
        isValid: errors.length === 0,
        errors
      };
    },

    onEnter: async function(wizardData) {
      // Obtener sugerencias de IA
      const empresaData = wizardData.empresa || {};
      const cargoData = wizardData[`cargo-info-${cargoIndex}`] || {};

      if (cargoData.cargoName) {
        const result = await fetchIA('/suggest-ges', {
          cargoName: cargoData.cargoName,
          sector: empresaData.sector
        });

        if (result.success && result.suggestions && result.suggestions.length > 0) {
          // Guardar en cache
          aiSuggestionsCache.ges[cargoIndex] = result.suggestions;

          // Mostrar sugerencias
          setTimeout(() => {
            const container = document.getElementById('ai-ges-suggestions');
            const chipsContainer = document.getElementById('ai-ges-chips');

            if (container && chipsContainer) {
              chipsContainer.innerHTML = result.suggestions.map(s => `
                <button
                  type="button"
                  class="suggestion-chip"
                  data-riesgo="${s.riesgo}"
                  data-category="${s.riesgo.split(' - ')[0]}"
                >
                  ${s.riesgo}
                  <span class="confidence">${s.confidence}% match</span>
                </button>
              `).join('');

              container.style.display = 'block';

              // Event listeners
              chipsContainer.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                  const riesgo = chip.dataset.riesgo;
                  const category = chip.dataset.category;

                  // Buscar y seleccionar el checkbox correspondiente
                  const checkbox = document.querySelector(
                    `input[type="checkbox"][data-category="${category}"][value*="${riesgo.split(' - ')[1] || riesgo}"]`
                  );

                  if (checkbox) {
                    checkbox.checked = !checkbox.checked;

                    // Toggle visual de la opci√≥n
                    const label = checkbox.closest('.wizard-option');
                    if (label) {
                      label.classList.toggle('selected', checkbox.checked);
                    }
                  }

                  // Toggle visual del chip
                  chip.classList.toggle('selected');
                });
              });
            }
          }, 100);
        }
      }

      // Event listeners para checkboxes (toggle visual)
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="ges-"]');
        checkboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            const label = cb.closest('.wizard-option');
            if (label) {
              label.classList.toggle('selected', cb.checked);
            }
          });
        });
      }, 100);
    }
  };
}

// =================================================================
// PASO 6: CONTROLES Y NIVELES PARA CADA GES (TODO EN UNO)
// =================================================================

export function createControlesStep(cargoIndex, gesIndex, cargoName, riesgo, ges) {
  const categoryColor = getCategoryColor(riesgo);

  return {
    id: `controles-${cargoIndex}-${gesIndex}`,
    title: `${ges}`,

    render: (data = {}) => {
      console.log(`üé® Rendering controles step cargo=${cargoIndex}, ges=${gesIndex}`);
      console.log(`üì¶ Data received:`, data);
      console.log(`üìå data.nd=${data.nd}, data.ne=${data.ne}, data.nc=${data.nc}`);
      console.log(`üìå data.fuente=${data.fuente}, data.medio=${data.medio}, data.individuo=${data.individuo}`);

      return html`
      <div style="border-left: 4px solid ${categoryColor}; padding-left: 2rem; margin-bottom: 2rem;">
        <h2 style="color: ${categoryColor}; margin-bottom: 0.5rem;">üõ°Ô∏è ${ges}</h2>
        <p style="color: #666; font-size: 1.4rem;">
          <strong>Cargo:</strong> ${cargoName} | <strong>Categor√≠a:</strong> ${riesgo}
        </p>
      </div>

      <!-- SECCI√ìN 1: NIVELES DE RIESGO (OBLIGATORIO) -->
      <!-- FIX 1.2: data-step-id fuerza a lit-html a recrear elementos cuando cambia -->
      <div data-step-id="controles-${cargoIndex}-${gesIndex}" style="background: #f8f9fa; border-radius: 12px; padding: 2.5rem; margin-bottom: 3rem;">
        <h3 style="font-size: 2rem; font-weight: 700; color: #383d47; margin-bottom: 2rem;">
          üìä Niveles de Riesgo GTC 45 <span style="color: #f44336;">*</span>
        </h3>

        <!-- Calculadora en tiempo real -->
        <div id="risk-calculator-${cargoIndex}-${gesIndex}" style="background: white; border-radius: 8px; padding: 2rem; margin-bottom: 2.5rem; display: none; border: 2px solid #e0e0e0;">
          <h4 style="font-size: 1.6rem; margin-bottom: 1.5rem; color: #383d47;">‚úÖ Resultado del C√°lculo</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">
            <div style="padding: 1.5rem; border-radius: 8px; background: #f8f9fa;">
              <div style="font-size: 1.2rem; color: #666; margin-bottom: 0.5rem;">Nivel de Probabilidad (NP)</div>
              <div id="np-value-${cargoIndex}-${gesIndex}" style="font-size: 2.4rem; font-weight: 700; color: #383d47;">-</div>
              <div id="np-interpretation-${cargoIndex}-${gesIndex}" style="font-size: 1.2rem; color: #666; margin-top: 0.5rem;"></div>
            </div>
            <div id="nr-card-${cargoIndex}-${gesIndex}" style="padding: 1.5rem; border-radius: 8px; background: #f8f9fa;">
              <div style="font-size: 1.2rem; color: #666; margin-bottom: 0.5rem;">Nivel de Riesgo (NR)</div>
              <div id="nr-value-${cargoIndex}-${gesIndex}" style="font-size: 2.4rem; font-weight: 700;">-</div>
              <div id="nr-level-${cargoIndex}-${gesIndex}" style="font-size: 1.6rem; font-weight: 600; margin-top: 0.5rem;"></div>
              <div id="nr-interpretation-${cargoIndex}-${gesIndex}" style="font-size: 1.2rem; margin-top: 0.5rem;"></div>
              <div id="nr-acceptability-${cargoIndex}-${gesIndex}" style="font-size: 1.2rem; font-weight: 600; margin-top: 0.5rem;"></div>
            </div>
          </div>
        </div>

        <!-- ND - Nivel de Deficiencia -->
        <div style="margin-bottom: 2.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <label style="font-size: 1.6rem; font-weight: 600; color: #383d47;">
              Nivel de Deficiencia (ND) <span style="color: #f44336;">*</span>
            </label>
            <button type="button" class="tooltip-btn" data-tooltip="nd" style="background: #5dc4af; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: help; font-weight: 700; font-size: 1.2rem;">?</button>
          </div>
          <p style="font-size: 1.3rem; color: #666; margin-bottom: 1.5rem;">
            Magnitud de la relaci√≥n entre las condiciones de trabajo y la posibilidad de da√±o
          </p>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <!-- BAJO (0) -->
            <label class="nivel-bar ${data.nd === '0' ? 'selected' : ''}" data-nivel-container="nd-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Riesgo bajo o aceptable, mantener controles">
              <input type="radio" id="nd-${cargoIndex}-${gesIndex}-0" name="nd-${cargoIndex}-${gesIndex}" value="0" ?checked=${data.nd === '0'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#4caf50" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nd === '0' ? '0 4px 12px rgba(76, 175, 80, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nd === '0' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nd === '0' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">0</div>
                <div style="font-size: 1.2rem; font-weight: 600;">Bajo</div>
              </div>
              <!-- Checkmark se agrega manualmente en afterRender/onChange -->
            </label>

            <!-- MEDIO (2) -->
            <label class="nivel-bar ${data.nd === '2' ? 'selected' : ''}" data-nivel-container="nd-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Riesgo medio, mejorar controles existentes">
              <input type="radio" name="nd-${cargoIndex}-${gesIndex}" value="2" ?checked=${data.nd === '2'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ffc107" style="background: linear-gradient(135deg, #ffc107 0%, #ffa000 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nd === '2' ? '0 4px 12px rgba(255, 193, 7, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nd === '2' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nd === '2' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">2</div>
                <div style="font-size: 1.2rem; font-weight: 600;">Medio</div>
              </div>
              <!-- Checkmark se agrega manualmente en afterRender/onChange -->
            </label>

            <!-- ALTO (6) -->
            <label class="nivel-bar ${data.nd === '6' ? 'selected' : ''}" data-nivel-container="nd-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Riesgo alto, requiere correcciones urgentes">
              <input type="radio" name="nd-${cargoIndex}-${gesIndex}" value="6" ?checked=${data.nd === '6'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ff9800" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nd === '6' ? '0 4px 12px rgba(255, 152, 0, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nd === '6' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nd === '6' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">6</div>
                <div style="font-size: 1.2rem; font-weight: 600;">Alto</div>
              </div>
              <!-- Checkmark se agrega manualmente en afterRender/onChange -->
            </label>

            <!-- MUY ALTO (10) -->
            <label class="nivel-bar ${data.nd === '10' ? 'selected' : ''}" data-nivel-container="nd-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Riesgo extremadamente alto, requiere acci√≥n inmediata">
              <input type="radio" name="nd-${cargoIndex}-${gesIndex}" value="10" ?checked=${data.nd === '10'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#f44336" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nd === '10' ? '0 4px 12px rgba(244, 67, 54, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nd === '10' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nd === '10' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">10</div>
                <div style="font-size: 1.2rem; font-weight: 600;">Muy Alto</div>
              </div>
              <!-- Checkmark se agrega manualmente en afterRender/onChange -->
            </label>
          </div>
        </div>

        <!-- NE - Nivel de Exposici√≥n -->
        <div style="margin-bottom: 2.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <label style="font-size: 1.6rem; font-weight: 600; color: #383d47;">
              Nivel de Exposici√≥n (NE) <span style="color: #f44336;">*</span>
            </label>
            <button type="button" class="tooltip-btn" data-tooltip="ne" style="background: #5dc4af; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: help; font-weight: 700; font-size: 1.2rem;">?</button>
          </div>
          <p style="font-size: 1.3rem; color: #666; margin-bottom: 1.5rem;">
            Frecuencia con que el trabajador se expone al factor de riesgo
          </p>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <!-- ESPOR√ÅDICA (1) -->
            <label class="nivel-bar ${data.ne === '1' ? 'selected' : ''}" data-nivel-container="ne-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Muy rara vez, menos del 5% de la jornada">
              <input type="radio" name="ne-${cargoIndex}-${gesIndex}" value="1" ?checked=${data.ne === '1'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#4caf50" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.ne === '1' ? '0 4px 12px rgba(76, 175, 80, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.ne === '1' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.ne === '1' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">1</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Espor√°dica</div>
              </div>
              ${data.ne === '1' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #4caf50; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- OCASIONAL (2) -->
            <label class="nivel-bar ${data.ne === '2' ? 'selected' : ''}" data-nivel-container="ne-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Alguna vez durante la jornada, menos del 50%">
              <input type="radio" name="ne-${cargoIndex}-${gesIndex}" value="2" ?checked=${data.ne === '2'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ffc107" style="background: linear-gradient(135deg, #ffc107 0%, #ffa000 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.ne === '2' ? '0 4px 12px rgba(255, 193, 7, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.ne === '2' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.ne === '2' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">2</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Ocasional</div>
              </div>
              ${data.ne === '2' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #ffc107; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- FRECUENTE (3) -->
            <label class="nivel-bar ${data.ne === '3' ? 'selected' : ''}" data-nivel-container="ne-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Varias veces al d√≠a, m√°s del 50% de la jornada">
              <input type="radio" name="ne-${cargoIndex}-${gesIndex}" value="3" ?checked=${data.ne === '3'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ff9800" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.ne === '3' ? '0 4px 12px rgba(255, 152, 0, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.ne === '3' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.ne === '3' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">3</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Frecuente</div>
              </div>
              ${data.ne === '3' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #ff9800; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- CONTINUA (4) -->
            <label class="nivel-bar ${data.ne === '4' ? 'selected' : ''}" data-nivel-container="ne-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Exposici√≥n continua durante toda la jornada">
              <input type="radio" name="ne-${cargoIndex}-${gesIndex}" value="4" ?checked=${data.ne === '4'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#f44336" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.ne === '4' ? '0 4px 12px rgba(244, 67, 54, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.ne === '4' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.ne === '4' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">4</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Continua</div>
              </div>
              ${data.ne === '4' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #f44336; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>
          </div>
        </div>

        <!-- NC - Nivel de Consecuencia -->
        <div style="margin-bottom: 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <label style="font-size: 1.6rem; font-weight: 600; color: #383d47;">
              Nivel de Consecuencia (NC) <span style="color: #f44336;">*</span>
            </label>
            <button type="button" class="tooltip-btn" data-tooltip="nc" style="background: #5dc4af; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: help; font-weight: 700; font-size: 1.2rem;">?</button>
          </div>
          <p style="font-size: 1.3rem; color: #666; margin-bottom: 1.5rem;">
            Resultado m√°s probable del accidente o enfermedad profesional
          </p>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <!-- LEVE (10) -->
            <label class="nivel-bar ${data.nc === '10' ? 'selected' : ''}" data-nivel-container="nc-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Lesiones leves, primeros auxilios, molestias">
              <input type="radio" name="nc-${cargoIndex}-${gesIndex}" value="10" ?checked=${data.nc === '10'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#4caf50" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nc === '10' ? '0 4px 12px rgba(76, 175, 80, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nc === '10' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nc === '10' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">10</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Leve</div>
              </div>
              ${data.nc === '10' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #4caf50; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- GRAVE (25) -->
            <label class="nivel-bar ${data.nc === '25' ? 'selected' : ''}" data-nivel-container="nc-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Lesiones con incapacidad laboral temporal">
              <input type="radio" name="nc-${cargoIndex}-${gesIndex}" value="25" ?checked=${data.nc === '25'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ff9800" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nc === '25' ? '0 4px 12px rgba(255, 152, 0, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nc === '25' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nc === '25' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">25</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Grave</div>
              </div>
              ${data.nc === '25' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #ff9800; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- MUY GRAVE (60) -->
            <label class="nivel-bar ${data.nc === '60' ? 'selected' : ''}" data-nivel-container="nc-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Lesiones graves irreversibles (amputaciones, fracturas mayores)">
              <input type="radio" name="nc-${cargoIndex}-${gesIndex}" value="60" ?checked=${data.nc === '60'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#ff5722" style="background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nc === '60' ? '0 4px 12px rgba(255, 87, 34, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nc === '60' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nc === '60' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">60</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Muy Grave</div>
              </div>
              ${data.nc === '60' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #ff5722; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>

            <!-- MORTAL (100) -->
            <label class="nivel-bar ${data.nc === '100' ? 'selected' : ''}" data-nivel-container="nc-${cargoIndex}-${gesIndex}" style="cursor: pointer; position: relative;" title="Muerte o da√±o irreversible">
              <input type="radio" name="nc-${cargoIndex}-${gesIndex}" value="100" ?checked=${data.nc === '100'} style="position: absolute; opacity: 0;" />
              <div class="nivel-bar-inner" data-color="#f44336" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; padding: 1.2rem; border-radius: 8px; text-align: center; transition: all 0.3s; box-shadow: ${data.nc === '100' ? '0 4px 12px rgba(244, 67, 54, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)'}; transform: ${data.nc === '100' ? 'scale(1.05)' : 'scale(1)'}; border: ${data.nc === '100' ? '3px solid #fff' : '3px solid transparent'};">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem;">100</div>
                <div style="font-size: 1.1rem; font-weight: 600;">Mortal</div>
              </div>
              ${data.nc === '100' ? html`
                <div class="checkmark-indicator" style="position: absolute; top: -8px; right: -8px; background: white; color: #f44336; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;">‚úì</div>
              ` : ''}
            </label>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN 2: CONTROLES (OPCIONAL) -->
      <div style="margin-bottom: 3rem;">
        <h3 style="font-size: 2rem; font-weight: 700; color: #383d47; margin-bottom: 1.5rem;">
          üõ°Ô∏è Controles Existentes <span style="font-size: 1.3rem; color: #666; font-weight: 400;">(Opcional)</span>
        </h3>

        <!-- FIX 1.4: Sugerencias de IA con skeleton loader -->
      <div id="ai-controls-suggestions-${cargoIndex}-${gesIndex}" class="ai-suggestions" style="display: block;">
        <!-- Skeleton loader (se muestra mientras carga) -->
        <div id="ai-skeleton-${cargoIndex}-${gesIndex}" class="ai-skeleton-loader">
          <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: #5dc4af;">
            ‚è≥ Generando sugerencias con IA...
          </p>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="skeleton-chip" style="height: 60px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px;"></div>
            <div class="skeleton-chip" style="height: 60px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px;"></div>
            <div class="skeleton-chip" style="height: 60px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px;"></div>
          </div>
        </div>

        <!-- Chips reales (se muestran cuando carga completa) -->
        <div id="ai-chips-content-${cargoIndex}-${gesIndex}" style="display: none;">
          <p style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">
            ‚ú® Controles sugeridos por IA:
          </p>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button
              type="button"
              id="btn-apply-fuente-${cargoIndex}-${gesIndex}"
              class="suggestion-chip"
              style="width: 100%; justify-content: space-between; padding: 1.5rem;"
            >
              <span><strong>Fuente:</strong> <span id="sugg-fuente-${cargoIndex}-${gesIndex}"></span></span>
              <span style="font-size: 1.2rem;">Aplicar ‚Üí</span>
            </button>
            <button
              type="button"
              id="btn-apply-medio-${cargoIndex}-${gesIndex}"
              class="suggestion-chip"
              style="width: 100%; justify-content: space-between; padding: 1.5rem;"
            >
              <span><strong>Medio:</strong> <span id="sugg-medio-${cargoIndex}-${gesIndex}"></span></span>
              <span style="font-size: 1.2rem;">Aplicar ‚Üí</span>
            </button>
            <button
              type="button"
              id="btn-apply-individuo-${cargoIndex}-${gesIndex}"
              class="suggestion-chip"
              style="width: 100%; justify-content: space-between; padding: 1.5rem;"
            >
              <span><strong>Individuo:</strong> <span id="sugg-individuo-${cargoIndex}-${gesIndex}"></span></span>
              <span style="font-size: 1.2rem;">Aplicar ‚Üí</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de controles -->
      <div style="display: flex; flex-direction: column; gap: 2.5rem; margin-top: 3rem;">
        <div>
          <label for="control-fuente-${cargoIndex}-${gesIndex}" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Control en la Fuente
          </label>
          <textarea
            id="control-fuente-${cargoIndex}-${gesIndex}"
            name="fuente"
            placeholder="Ej: Mantenimiento preventivo, guardas de seguridad. Si no hay controles escriba 'Ninguno'"
            rows="3"
          >${data.fuente || ''}</textarea>
          <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
            Acciones para eliminar o reducir el riesgo en su origen. Si no hay controles, escriba "Ninguno"
          </p>
        </div>

        <div>
          <label for="control-medio-${cargoIndex}-${gesIndex}" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Control en el Medio
          </label>
          <textarea
            id="control-medio-${cargoIndex}-${gesIndex}"
            name="medio"
            placeholder="Ej: Se√±alizaci√≥n, ventilaci√≥n, barreras f√≠sicas. Si no hay controles escriba 'Ninguno'"
            rows="3"
          >${data.medio || ''}</textarea>
          <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
            Medidas para reducir la exposici√≥n durante la trayectoria del riesgo. Si no hay, escriba "Ninguno"
          </p>
        </div>

        <div>
          <label for="control-individuo-${cargoIndex}-${gesIndex}" style="display: block; font-weight: 600; margin-bottom: 0.8rem; color: #383d47;">
            Control en el Individuo
          </label>
          <textarea
            id="control-individuo-${cargoIndex}-${gesIndex}"
            name="individuo"
            placeholder="Ej: EPP (guantes, gafas, protecci√≥n auditiva), capacitaci√≥n. Si no hay escriba 'Ninguno'"
            rows="3"
          >${data.individuo || ''}</textarea>
          <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
            Equipos de protecci√≥n personal y entrenamiento. Si no hay controles, escriba "Ninguno"
          </p>
        </div>
      </div>

      <div class="wizard-hint" style="margin-top: 3rem;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
        </svg>
        <span>
          Los controles deben estar ordenados por jerarqu√≠a: primero eliminar el riesgo,
          luego proteger al trabajador.
        </span>
      </div>
    `;
    },

    getData: () => {
      return {
        // Controles (opcionales) - con IDs √∫nicos
        fuente: document.getElementById(`control-fuente-${cargoIndex}-${gesIndex}`)?.value || '',
        medio: document.getElementById(`control-medio-${cargoIndex}-${gesIndex}`)?.value || '',
        individuo: document.getElementById(`control-individuo-${cargoIndex}-${gesIndex}`)?.value || '',
        // Niveles (obligatorios)
        nd: document.querySelector(`input[name="nd-${cargoIndex}-${gesIndex}"]:checked`)?.value,
        ne: document.querySelector(`input[name="ne-${cargoIndex}-${gesIndex}"]:checked`)?.value,
        nc: document.querySelector(`input[name="nc-${cargoIndex}-${gesIndex}"]:checked`)?.value
      };
    },

    validate: (data) => {
      const errors = [];

      // Validar NIVELES (OBLIGATORIOS)
      if (!data.nd) {
        errors.push({ field: 'nd', message: 'Debe seleccionar el Nivel de Deficiencia (ND)' });
      }

      if (!data.ne) {
        errors.push({ field: 'ne', message: 'Debe seleccionar el Nivel de Exposici√≥n (NE)' });
      }

      if (!data.nc) {
        errors.push({ field: 'nc', message: 'Debe seleccionar el Nivel de Consecuencia (NC)' });
      }

      // Los controles NO son obligatorios

      return {
        isValid: errors.length === 0,
        errors
      };
    },

    afterRender: async function(wizardData) {
      // ‚ö° CR√çTICO: Este hook se ejecuta INMEDIATAMENTE despu√©s del render
      // y ANTES de la animaci√≥n de entrada, para limpiar el DOM antes de que el usuario lo vea
      const stepData = wizardData[`controles-${cargoIndex}-${gesIndex}`] || {};
      console.log(`üßπ afterRender: Limpiando radio buttons para controles-${cargoIndex}-${gesIndex}`);
      console.log(`üì¶ Stored data:`, stepData);

      // Funci√≥n que espera hasta que los elementos existan (con retry, m√°ximo 3 intentos)
      const forceRadioStates = (attempt = 1) => {
        const radioButtonsND = document.querySelectorAll(`input[name="nd-${cargoIndex}-${gesIndex}"]`);
        const radioButtonsNE = document.querySelectorAll(`input[name="ne-${cargoIndex}-${gesIndex}"]`);
        const radioButtonsNC = document.querySelectorAll(`input[name="nc-${cargoIndex}-${gesIndex}"]`);

        console.log(`üîß [Attempt ${attempt}] Forzando estado...`);
        console.log(`Found radios: ND=${radioButtonsND.length}, NE=${radioButtonsNE.length}, NC=${radioButtonsNC.length}`);

        // Si no existen, reintentar (m√°ximo 3 intentos, m√°s r√°pido)
        if (radioButtonsND.length === 0 && attempt < 3) {
          console.log(`‚è≥ Reintentando en 10ms...`);
          setTimeout(() => forceRadioStates(attempt + 1), 10);
          return;
        }

        // Si despu√©s de 3 intentos no hay elementos, salir
        if (radioButtonsND.length === 0) {
          console.error('‚ùå ERROR: No se encontraron radio buttons despu√©s de 3 intentos');
          return;
        }

        // PASO 1: LIMPIAR todos los radio buttons primero (desmarcar todo)
        // CR√çTICO: Tambi√©n remover el atributo HTML 'checked' para forzar a lit-html a limpiar el DOM
        [...radioButtonsND, ...radioButtonsNE, ...radioButtonsNC].forEach(btn => {
          btn.checked = false;
          btn.removeAttribute('checked'); // ‚Üê Remover atributo HTML que persiste entre renders
        });

        // PASO 2: Marcar solo los que deben estar checked seg√∫n stepData
        let ndChecked = 0, neChecked = 0, ncChecked = 0;

        radioButtonsND.forEach(btn => {
          const match = (btn.value === stepData.nd);
          console.log(`  üîç ND: btn.value="${btn.value}" === stepData.nd="${stepData.nd}"? ${match}`);
          if (match) {
            btn.checked = true;
            btn.setAttribute('checked', 'checked'); // ‚Üê Tambi√©n agregar atributo HTML
            ndChecked++;
            console.log(`  ‚úÖ ND: Marcando ${btn.value} como checked`);
          }
        });

        radioButtonsNE.forEach(btn => {
          const match = (btn.value === stepData.ne);
          if (match) {
            btn.checked = true;
            btn.setAttribute('checked', 'checked'); // ‚Üê Tambi√©n agregar atributo HTML
            neChecked++;
            console.log(`  ‚úÖ NE: Marcando ${btn.value} como checked`);
          }
        });

        radioButtonsNC.forEach(btn => {
          const match = (btn.value === stepData.nc);
          if (match) {
            btn.checked = true;
            btn.setAttribute('checked', 'checked'); // ‚Üê Tambi√©n agregar atributo HTML
            ncChecked++;
            console.log(`  ‚úÖ NC: Marcando ${btn.value} como checked`);
          }
        });

        console.log(`üìä Radios marcados: ND=${ndChecked}, NE=${neChecked}, NC=${ncChecked}`);

        // PASO 3: Restaurar valores en textareas
        const fuenteTextarea = document.getElementById(`control-fuente-${cargoIndex}-${gesIndex}`);
        const medioTextarea = document.getElementById(`control-medio-${cargoIndex}-${gesIndex}`);
        const individuoTextarea = document.getElementById(`control-individuo-${cargoIndex}-${gesIndex}`);

        if (fuenteTextarea) fuenteTextarea.value = stepData.fuente || '';
        if (medioTextarea) medioTextarea.value = stepData.medio || '';
        if (individuoTextarea) individuoTextarea.value = stepData.individuo || '';

        console.log(`‚úÖ Estado forzado. Datos: ND=${stepData.nd}, NE=${stepData.ne}, NC=${stepData.nc}`);

        // PASO 4: Restaurar clase 'selected' y mostrar calculadora si hay datos
        const allRadioButtons = [...radioButtonsND, ...radioButtonsNE, ...radioButtonsNC];
        allRadioButtons.forEach(btn => {
          if (btn.checked) {
            const label = btn.closest('.nivel-bar');
            if (label) {
              label.classList.add('selected');
            }
          }
        });

        // PASO 5: Ocultar calculadora por defecto (se mostrar√° cuando se calculen valores)
        const calculator = document.getElementById(`risk-calculator-${cargoIndex}-${gesIndex}`);
        if (calculator) {
          // Siempre ocultar al inicio, se mostrar√° en el evento 'change' o en el setTimeout principal
          calculator.style.display = stepData.nd && stepData.ne && stepData.nc ? 'block' : 'none';
        }
      }; // Fin de forceRadioStates

      // Llamar inmediatamente (sincr√≥nicamente)
      forceRadioStates();
    },

    onEnter: async function(wizardData) {
      console.log(`üéØ onEnter: controles step for cargo ${cargoIndex}, GES ${gesIndex}`);
      console.log(`üìö Current aiSuggestionsCache.controls:`, aiSuggestionsCache.controls);

      // Obtener datos guardados (necesario para calculadora y setup)
      const stepData = wizardData[`controles-${cargoIndex}-${gesIndex}`] || {};

      // 1. FIX 1.4: Funci√≥n para mostrar sugerencias con skeleton loader
      const showSuggestions = (controls) => {
        // Usar MutationObserver para esperar a que el DOM est√© listo
        const waitForElement = (selector, callback) => {
          const element = document.querySelector(selector);
          if (element) {
            callback(element);
            return;
          }

          const observer = new MutationObserver((mutations, obs) => {
            const el = document.querySelector(selector);
            if (el) {
              obs.disconnect();
              callback(el);
            }
          });

          observer.observe(document.body, {
            childList: true,
            subtree: true
          });

          // Timeout de seguridad (5 segundos)
          setTimeout(() => observer.disconnect(), 5000);
        };

        // Esperar a que existan los elementos antes de manipularlos
        waitForElement(`#ai-skeleton-${cargoIndex}-${gesIndex}`, (skeleton) => {
          const chipsContent = document.getElementById(`ai-chips-content-${cargoIndex}-${gesIndex}`);
          const suggFuente = document.getElementById(`sugg-fuente-${cargoIndex}-${gesIndex}`);
          const suggMedio = document.getElementById(`sugg-medio-${cargoIndex}-${gesIndex}`);
          const suggIndividuo = document.getElementById(`sugg-individuo-${cargoIndex}-${gesIndex}`);

          console.log(`üí° showSuggestions called for cargo=${cargoIndex}, ges=${gesIndex}`);
          console.log(`Elements found: skeleton=${!!skeleton}, content=${!!chipsContent}, fuente=${!!suggFuente}`);

          if (chipsContent && suggFuente && suggMedio && suggIndividuo) {
            // Ocultar skeleton
            skeleton.style.display = 'none';

            // Mostrar chips reales
            chipsContent.style.display = 'block';

            // Llenar texto (truncar si es muy largo)
            suggFuente.textContent = controls.fuente.substring(0, 80) + (controls.fuente.length > 80 ? '...' : '');
            suggMedio.textContent = controls.medio.substring(0, 80) + (controls.medio.length > 80 ? '...' : '');
            suggIndividuo.textContent = controls.individuo.substring(0, 80) + (controls.individuo.length > 80 ? '...' : '');

            // FIX CR√çTICO: Guardar IDs en dataset para evitar problemas de closure
            // Los IDs cambian por cargo/ges, guardarlos en el bot√≥n garantiza que siempre apunten correctamente
            const btnFuente = document.getElementById(`btn-apply-fuente-${cargoIndex}-${gesIndex}`);
            const btnMedio = document.getElementById(`btn-apply-medio-${cargoIndex}-${gesIndex}`);
            const btnIndividuo = document.getElementById(`btn-apply-individuo-${cargoIndex}-${gesIndex}`);

            if (btnFuente) {
              // Guardar tanto el texto como el ID del textarea destino
              btnFuente.dataset.controlText = controls.fuente;
              btnFuente.dataset.targetTextarea = `control-fuente-${cargoIndex}-${gesIndex}`;

              if (btnFuente.dataset.listenerAdded !== 'true') {
                btnFuente.addEventListener('click', (e) => {
                  const textareaId = e.currentTarget.dataset.targetTextarea;
                  const text = e.currentTarget.dataset.controlText;
                  console.log(`üîò Click en chip fuente - buscando ${textareaId}`);

                  const textarea = document.getElementById(textareaId);
                  console.log(`Textarea found: ${!!textarea}`);

                  if (textarea && text) {
                    textarea.value = text;
                    console.log('‚úÖ Texto aplicado:', text.substring(0, 50));
                  } else {
                    console.error(`‚ùå Textarea o texto no encontrado. ID: ${textareaId}, Textarea: ${!!textarea}, Text: ${!!text}`);
                  }
                });
                btnFuente.dataset.listenerAdded = 'true';
              }
            }

            if (btnMedio) {
              btnMedio.dataset.controlText = controls.medio;
              btnMedio.dataset.targetTextarea = `control-medio-${cargoIndex}-${gesIndex}`;

              if (btnMedio.dataset.listenerAdded !== 'true') {
                btnMedio.addEventListener('click', (e) => {
                  const textareaId = e.currentTarget.dataset.targetTextarea;
                  const text = e.currentTarget.dataset.controlText;
                  console.log(`üîò Click en chip medio - buscando ${textareaId}`);

                  const textarea = document.getElementById(textareaId);
                  console.log(`Textarea found: ${!!textarea}`);

                  if (textarea && text) {
                    textarea.value = text;
                    console.log('‚úÖ Texto aplicado:', text.substring(0, 50));
                  } else {
                    console.error(`‚ùå Textarea o texto no encontrado. ID: ${textareaId}, Textarea: ${!!textarea}, Text: ${!!text}`);
                  }
                });
                btnMedio.dataset.listenerAdded = 'true';
              }
            }

            if (btnIndividuo) {
              btnIndividuo.dataset.controlText = controls.individuo;
              btnIndividuo.dataset.targetTextarea = `control-individuo-${cargoIndex}-${gesIndex}`;

              if (btnIndividuo.dataset.listenerAdded !== 'true') {
                btnIndividuo.addEventListener('click', (e) => {
                  const textareaId = e.currentTarget.dataset.targetTextarea;
                  const text = e.currentTarget.dataset.controlText;
                  console.log(`üîò Click en chip individuo - buscando ${textareaId}`);

                  const textarea = document.getElementById(textareaId);
                  console.log(`Textarea found: ${!!textarea}`);

                  if (textarea && text) {
                    textarea.value = text;
                    console.log('‚úÖ Texto aplicado:', text.substring(0, 50));
                  } else {
                    console.error(`‚ùå Textarea o texto no encontrado. ID: ${textareaId}, Textarea: ${!!textarea}, Text: ${!!text}`);
                  }
                });
                btnIndividuo.dataset.listenerAdded = 'true';
              }
            }
          } else {
            console.error('‚ùå No se pudieron encontrar los elementos para mostrar chips');
          }
        });
      };

      // 2. Verificar cache primero
      const cachedControls = aiSuggestionsCache.controls[cargoIndex]?.[gesIndex];
      console.log(`üîç Checking cache for cargo=${cargoIndex}, ges=${gesIndex}: ${cachedControls ? 'FOUND' : 'NOT FOUND'}`);

      if (cachedControls) {
        console.log('‚ú® Using cached AI controls:', cachedControls);
        showSuggestions(cachedControls);
      } else {
        // 3. Obtener sugerencias de IA para controles DE FORMA NO BLOQUEANTE
        const empresaData = wizardData.empresa || {};
        const cargoData = wizardData[`cargo-info-${cargoIndex}`] || {};

        console.log('üìä Fetching AI controls for:', { riesgo, ges, cargoName: cargoData.cargoName, sector: empresaData.sector });

        fetchIA('/suggest-controls', {
          riesgo,
          ges,
          cargoName: cargoData.cargoName,
          sector: empresaData.sector
        }).then(result => {
          console.log('‚úÖ AI controls result:', result);

          if (result.success && result.controls) {
            // Guardar en cache
            if (!aiSuggestionsCache.controls[cargoIndex]) {
              aiSuggestionsCache.controls[cargoIndex] = {};
            }
            aiSuggestionsCache.controls[cargoIndex][gesIndex] = result.controls;

            // Mostrar sugerencias
            showSuggestions(result.controls);
          }
        }).catch(error => {
          console.error('‚ùå Error fetching AI controls:', error);
          // No mostrar error al usuario, simplemente no cargar sugerencias
        });
      }

      // 2. Setup calculadora de niveles en tiempo real y event listeners
      setTimeout(() => {
        // Obtener referencias (ya fueron forzados arriba)
        const radioButtonsND = document.querySelectorAll(`input[name="nd-${cargoIndex}-${gesIndex}"]`);
        const radioButtonsNE = document.querySelectorAll(`input[name="ne-${cargoIndex}-${gesIndex}"]`);
        const radioButtonsNC = document.querySelectorAll(`input[name="nc-${cargoIndex}-${gesIndex}"]`);
        const allRadioButtons = [...radioButtonsND, ...radioButtonsNE, ...radioButtonsNC];

        const calculatorId = `risk-calculator-${cargoIndex}-${gesIndex}`;

        console.log(`üéØ Setting up nivel listeners for cargo ${cargoIndex}, GES ${gesIndex}`);
        console.log(`Found ${allRadioButtons.length} radio buttons`);

        // CR√çTICO: Verificar que los elementos existen antes de continuar
        if (allRadioButtons.length === 0) {
          console.error('‚ùå No se encontraron radio buttons. Reintentando...');
          // Reintentar despu√©s de m√°s tiempo
          setTimeout(() => arguments.callee(), 300);
          return;
        }

        // FIX 1.3: Calculadora basada en par√°metros (no lee DOM directamente)
        const calculateRisk = (ndValue, neValue, ncValue) => {
          // Si no se pasan par√°metros, leer del DOM (para eventos change)
          const nd = ndValue || document.querySelector(`input[name="nd-${cargoIndex}-${gesIndex}"]:checked`)?.value;
          const ne = neValue || document.querySelector(`input[name="ne-${cargoIndex}-${gesIndex}"]:checked`)?.value;
          const nc = ncValue || document.querySelector(`input[name="nc-${cargoIndex}-${gesIndex}"]:checked`)?.value;

          console.log(`üßÆ calculateRisk called with: ND=${nd}, NE=${ne}, NC=${nc}`);

          if (nd && ne && nc) {
            const ndVal = parseInt(nd, 10);
            const neVal = parseInt(ne, 10);
            const ncVal = parseInt(nc, 10);

            // Calcular NP
            const np = ndVal * neVal;
            let npLevel = '';
            if (np >= 24) npLevel = 'Muy Alto';
            else if (np >= 10) npLevel = 'Alto';
            else if (np >= 6) npLevel = 'Medio';
            else npLevel = 'Bajo';

            // Calcular NR
            const nr = np * ncVal;
            let nrData = {};
            if (nr >= 600) {
              nrData = { nivel: 'I', interpretacion: 'Situaci√≥n cr√≠tica. Correcci√≥n urgente', aceptabilidad: 'No Aceptable', color: '#FF0000' };
            } else if (nr >= 150) {
              nrData = { nivel: 'II', interpretacion: 'Corregir o adoptar medidas de control', aceptabilidad: 'No Aceptable o Aceptable con control espec√≠fico', color: '#FFA500' };
            } else if (nr >= 40) {
              nrData = { nivel: 'III', interpretacion: 'Mejorar el control existente', aceptabilidad: 'Mejorable', color: '#FFFF00' };
            } else {
              nrData = { nivel: 'IV', interpretacion: 'No intervenir, salvo que an√°lisis lo justifique', aceptabilidad: 'Aceptable', color: '#008000' };
            }

            // Actualizar UI
            const calculator = document.getElementById(calculatorId);
            if (calculator) {
              calculator.style.display = 'block';

              const npValueEl = document.getElementById(`np-value-${cargoIndex}-${gesIndex}`);
              const npInterpEl = document.getElementById(`np-interpretation-${cargoIndex}-${gesIndex}`);
              if (npValueEl) npValueEl.textContent = np;
              if (npInterpEl) npInterpEl.textContent = npLevel;

              const nrCard = document.getElementById(`nr-card-${cargoIndex}-${gesIndex}`);
              if (nrCard) {
                nrCard.style.borderColor = nrData.color;
                nrCard.style.borderWidth = '3px';
              }

              const nrValueEl = document.getElementById(`nr-value-${cargoIndex}-${gesIndex}`);
              const nrLevelEl = document.getElementById(`nr-level-${cargoIndex}-${gesIndex}`);
              const nrInterpEl = document.getElementById(`nr-interpretation-${cargoIndex}-${gesIndex}`);
              const nrAcceptEl = document.getElementById(`nr-acceptability-${cargoIndex}-${gesIndex}`);

              if (nrValueEl) {
                nrValueEl.textContent = nr;
                nrValueEl.style.color = nrData.color;
              }
              if (nrLevelEl) {
                nrLevelEl.textContent = `Nivel ${nrData.nivel}`;
                nrLevelEl.style.color = nrData.color;
              }
              if (nrInterpEl) nrInterpEl.textContent = nrData.interpretacion;
              if (nrAcceptEl) nrAcceptEl.textContent = `Aceptabilidad: ${nrData.aceptabilidad}`;
            }
          }
        };

        // Event listeners para c√°lculo en tiempo real (SOLO SI NO EXISTE YA)
        allRadioButtons.forEach(radio => {
          // Prevenir event listeners duplicados
          if (radio.dataset.listenerAdded !== 'true') {
            radio.addEventListener('change', () => {
              console.log(`‚úÖ Radio changed: ${radio.name} = ${radio.value}`);

              // Toggle visual - scale effect + checkmarks
              const label = radio.closest('.nivel-bar');
              if (label) {
                // IMPORTANTE: Solo buscar dentro de este grupo espec√≠fico usando el data-nivel-container
                const nivelContainer = label.getAttribute('data-nivel-container');
                const allLabelsInGroup = document.querySelectorAll(`.nivel-bar[data-nivel-container="${nivelContainer}"]`);

                // Remover clase selected y checkmarks de TODOS los labels del grupo
                allLabelsInGroup.forEach(lbl => {
                  lbl.classList.remove('selected');
                  const existingCheck = lbl.querySelector('.checkmark-indicator');
                  if (existingCheck) existingCheck.remove();
                });

                // Agregar selected al label actual
                label.classList.add('selected');

                // Agregar checkmark al label seleccionado
                const levelDiv = label.querySelector('.nivel-bar-inner');
                if (levelDiv) {
                  // Obtener color del data-attribute
                  const checkColor = levelDiv.getAttribute('data-color') || '#f44336';

                  const checkmark = document.createElement('div');
                  checkmark.className = 'checkmark-indicator';
                  checkmark.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: white;
                    color: ${checkColor};
                    border-radius: 50%;
                    width: 28px;
                    height: 28px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.6rem;
                    font-weight: 800;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 10;
                  `;
                  checkmark.textContent = '‚úì';
                  label.appendChild(checkmark);
                }
              }

              // Calcular
              calculateRisk();
            });

            // Marcar que ya tiene listener
            radio.dataset.listenerAdded = 'true';
          }
        });

        // Calcular con valores guardados (no leer DOM que puede estar incorrecto)
        calculateRisk(stepData.nd, stepData.ne, stepData.nc);

        // 3. Setup tooltips
        const tooltipButtons = document.querySelectorAll('.tooltip-btn');
        console.log(`üí° Found ${tooltipButtons.length} tooltip buttons`);

        const tooltipTexts = {
          nd: 'Nivel de Deficiencia (ND): Magnitud de la relaci√≥n esperada entre el conjunto de peligros detectados y su relaci√≥n causal directa con posibles incidentes y con la eficacia de medidas preventivas existentes en un lugar de trabajo.\n\n‚Ä¢ Muy Alto (10): Se han detectado peligros que determinan como posible la generaci√≥n de incidentes o consecuencias muy significativas, o la eficacia del conjunto de medidas preventivas es nula o no existe, o ambos.\n‚Ä¢ Alto (6): Se han detectado algunos peligros que pueden dar lugar a consecuencias significativas, o el conjunto de medidas preventivas existentes respecto al riesgo es insuficiente, o ambos.\n‚Ä¢ Medio (2): Se han detectado peligros que pueden dar lugar a consecuencias poco significativas o de menor importancia, o el conjunto de medidas preventivas existentes es parcialmente eficaz.\n‚Ä¢ Bajo (0): No se ha detectado consecuencia alguna, o el conjunto de medidas preventivas existentes es eficaz.',

          ne: 'Nivel de Exposici√≥n (NE): Frecuencia con la que se est√° expuesto al riesgo.\n\n‚Ä¢ Continua (4): La situaci√≥n de exposici√≥n se presenta sin interrupci√≥n o varias veces con tiempo prolongado durante la jornada laboral.\n‚Ä¢ Frecuente (3): La situaci√≥n de exposici√≥n se presenta varias veces durante la jornada laboral por tiempos cortos.\n‚Ä¢ Ocasional (2): La situaci√≥n de exposici√≥n se presenta alguna vez durante la jornada laboral y por un periodo de tiempo corto.\n‚Ä¢ Espor√°dica (1): La situaci√≥n de exposici√≥n se presenta de manera eventual.',

          nc: 'Nivel de Consecuencia (NC): Resultado m√°s probable de un accidente debido al riesgo considerado, incluyendo da√±os personales y materiales.\n\n‚Ä¢ Mortal o Catastr√≥fico (100): Muerte(s) o p√©rdidas materiales muy graves.\n‚Ä¢ Muy Grave (60): Lesiones graves irreversibles (incapacidad permanente parcial o invalidez).\n‚Ä¢ Grave (25): Lesiones con incapacidad laboral temporal (ILT).\n‚Ä¢ Leve (10): Lesiones que no requieren hospitalizaci√≥n (primeros auxilios).'
        };

        tooltipButtons.forEach(btn => {
          // Solo agregar listener si no tiene uno ya (evita duplicados)
          if (btn.dataset.listenerAdded !== 'true') {
            const tooltipType = btn.dataset.tooltip;

            btn.addEventListener('click', (e) => {
              e.preventDefault();
              const text = tooltipTexts[tooltipType];
              if (text) {
                alert(text); // Temporal - luego podemos hacer un modal bonito
              }
            });

            // Marcar que ya tiene listener
            btn.dataset.listenerAdded = 'true';
          }
        });
      }, 300);
    }
  };
}

// =================================================================
// NOTA: La funci√≥n createNivelesRiesgoStep ha sido ELIMINADA (Sprint 1 - Consolidaci√≥n).
//
// Los niveles (ND, NE, NC) ahora est√°n INTEGRADOS en createControlesStep (ver arriba).
// Esto reduce el n√∫mero de pasos del wizard y mejora la UX al tener todo en una vista.
//
// Cambio realizado: 2025-02-11
// Raz√≥n: Consolidar controles + niveles en un solo slide con barritas semaforizadas
// =================================================================

// =================================================================
// PASO 8: REVISI√ìN Y CONFIRMACI√ìN
// =================================================================

export const reviewStep = {
  id: 'review',
  title: 'Revisi√≥n Final',

  onEnter: function(wizardData) {
    // Procesar y guardar datos para el render
    const empresa = wizardData.empresa || {};
    const cargos = [];

    // Extraer todos los cargos del wizardData
    Object.keys(wizardData).forEach(key => {
      if (key.startsWith('cargo-info-')) {
        const cargoIndex = parseInt(key.split('-')[2], 10);
        const cargoInfo = wizardData[key];
        const gesData = wizardData[`ges-selection-${cargoIndex}`] || {};

        cargos.push({
          ...cargoInfo,
          gesSeleccionados: gesData.gesSeleccionados || []
        });
      }
    });

    // Guardar datos procesados para el render
    this.data['review'] = {
      empresa,
      cargos,
      totalTrabajadores: cargos.reduce((sum, c) => sum + parseInt(c.numTrabajadores || 0, 10), 0),
      totalRiesgos: cargos.reduce((sum, c) => sum + (c.gesSeleccionados?.length || 0), 0)
    };

    console.log('üìä Review data prepared:', this.data['review']);

    // Re-render para mostrar datos
    this.render();
  },

  render: (data = {}) => {
    const { empresa = {}, cargos = [], totalTrabajadores = 0, totalRiesgos = 0 } = data;

    console.log('üìã Rendering review with:', { empresa, cargos, totalTrabajadores, totalRiesgos });

    return html`
      <h2>‚úÖ Revisi√≥n Final</h2>
      <p>Revisa toda la informaci√≥n antes de generar los documentos.</p>

      <!-- Resumen de empresa -->
      <div style="background: white; border-radius: 12px; padding: 2rem; margin-top: 3rem; border: 2px solid #e0e0e0;">
        <h3 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; color: #383d47;">
          üìã Empresa
        </h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Nombre</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.nombre || 'Sin datos'}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">NIT</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.nit || 'Sin datos'}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Sector</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.sector || 'Sin datos'}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Ciudad</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.ciudad || 'Sin datos'}</p>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-top: 2rem;">
        <div style="background: linear-gradient(135deg, rgba(93, 196, 175, 0.1), rgba(93, 196, 175, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #5dc4af;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #5dc4af;">${cargos.length}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Cargos</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(56, 61, 71, 0.1), rgba(56, 61, 71, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #383d47;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #383d47;">${totalTrabajadores}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Trabajadores</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #ff9800;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #ff9800;">${totalRiesgos}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Riesgos Identificados</div>
        </div>
      </div>

      <!-- Lista de cargos -->
      ${cargos.length > 0 ? html`
        <div style="margin-top: 3rem;">
          <h3 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; color: #383d47;">
            üë• Cargos Evaluados
          </h3>
          ${cargos.map((cargo, idx) => html`
            <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem; border: 2px solid #e0e0e0;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                  <h4 style="font-size: 1.6rem; font-weight: 600; color: #383d47;">${cargo.cargoName || 'Sin nombre'}</h4>
                  <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
                    ${cargo.area || 'Sin √°rea'} ‚Ä¢ ${cargo.numTrabajadores || 0} trabajador${cargo.numTrabajadores > 1 ? 'es' : ''}
                  </p>
                </div>
                <div style="background: #5dc4af; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 1.3rem; font-weight: 600;">
                  ${cargo.gesSeleccionados?.length || 0} riesgo${cargo.gesSeleccionados?.length !== 1 ? 's' : ''}
                </div>
              </div>
              ${cargo.gesSeleccionados && cargo.gesSeleccionados.length > 0 ? html`
                <div style="margin-top: 1rem;">
                  <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.8rem;">Riesgos identificados:</p>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.8rem;">
                    ${cargo.gesSeleccionados.map(g => html`
                      <span style="background: rgba(93, 196, 175, 0.1); color: #383d47; padding: 0.5rem 1rem; border-radius: 8px; font-size: 1.2rem; border: 1px solid #5dc4af;">
                        ${g.ges}
                      </span>
                    `)}
                  </div>
                </div>
              ` : ''}
            </div>
          `)}
        </div>
      ` : html`
        <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid #ff9800; border-radius: 12px; padding: 2rem; margin-top: 3rem; text-align: center;">
          <p style="font-size: 1.5rem; color: #ff9800;">‚ö†Ô∏è No se encontraron cargos evaluados</p>
        </div>
      `}

      <div class="wizard-hint" style="margin-top: 3rem;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
        </svg>
        <span>
          Al finalizar se generar√°n autom√°ticamente: Matriz de Riesgos, Profesiograma y Perfiles de Cargo.
        </span>
      </div>
    `;
  },

  getData: () => {
    // No necesitamos recolectar datos adicionales en este paso
    return {};
  },

  validate: () => {
    // Siempre v√°lido, es solo revisi√≥n
    return { isValid: true, errors: [] };
  }
};

// Versi√≥n antigua comentada por si la necesitas de referencia
/*
export const reviewStepOLD = {
  render: (wizardData) => {
    const empresa = wizardData.empresa || {};
    const cargos = [];

    Object.keys(wizardData).forEach(key => {
      if (key.startsWith('cargo-info-')) {
        const cargoIndex = parseInt(key.split('-')[2], 10);
        const cargoInfo = wizardData[key];
        const gesData = wizardData[`ges-selection-${cargoIndex}`] || {};

        cargos.push({
          ...cargoInfo,
          gesSeleccionados: gesData.gesSeleccionados || []
        });
      }
    });

    const totalTrabajadores = cargos.reduce((sum, c) => sum + (c.numTrabajadores || 0), 0);
    const totalRiesgos = cargos.reduce((sum, c) => sum + (c.gesSeleccionados?.length || 0), 0);

    return html`
      <h2>‚úÖ Revisi√≥n Final</h2>
      <p>Revisa toda la informaci√≥n antes de generar los documentos.</p>

      <!-- Resumen de empresa -->
      <div style="background: white; border-radius: 12px; padding: 2rem; margin-top: 3rem; border: 2px solid #e0e0e0;">
        <h3 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; color: #383d47;">
          üìã Empresa
        </h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Nombre</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.nombre}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">NIT</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.nit}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Sector</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.sector}</p>
          </div>
          <div>
            <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.5rem;">Ciudad</p>
            <p style="font-size: 1.5rem; font-weight: 600;">${empresa.ciudad}</p>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-top: 2rem;">
        <div style="background: linear-gradient(135deg, rgba(93, 196, 175, 0.1), rgba(93, 196, 175, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #5dc4af;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #5dc4af;">${cargos.length}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Cargos</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(56, 61, 71, 0.1), rgba(56, 61, 71, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #383d47;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #383d47;">${totalTrabajadores}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Trabajadores</div>
        </div>
        <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05)); border-radius: 12px; padding: 2rem; text-align: center; border: 2px solid #ff9800;">
          <div style="font-size: 3.6rem; font-weight: 700; color: #ff9800;">${totalRiesgos}</div>
          <div style="font-size: 1.4rem; color: #666; margin-top: 0.5rem;">Riesgos Identificados</div>
        </div>
      </div>

      <!-- Lista de cargos -->
      <div style="margin-top: 3rem;">
        <h3 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; color: #383d47;">
          üë• Cargos Evaluados
        </h3>
        ${cargos.map((cargo, idx) => html`
          <div style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem; border: 2px solid #e0e0e0;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div>
                <h4 style="font-size: 1.6rem; font-weight: 600; color: #383d47;">${cargo.cargoName}</h4>
                <p style="font-size: 1.3rem; color: #666; margin-top: 0.5rem;">
                  ${cargo.area} ‚Ä¢ ${cargo.numTrabajadores} trabajador${cargo.numTrabajadores > 1 ? 'es' : ''}
                </p>
              </div>
              <div style="background: #5dc4af; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 1.3rem; font-weight: 600;">
                ${cargo.gesSeleccionados?.length || 0} riesgo${cargo.gesSeleccionados?.length !== 1 ? 's' : ''}
              </div>
            </div>
            ${cargo.gesSeleccionados && cargo.gesSeleccionados.length > 0 ? html`
              <div style="margin-top: 1rem;">
                <p style="font-size: 1.3rem; color: #666; margin-bottom: 0.8rem;">Riesgos identificados:</p>
                <div style="display: flex; flex-wrap: wrap; gap: 0.8rem;">
                  ${cargo.gesSeleccionados.map(g => html`
                    <span style="background: rgba(93, 196, 175, 0.1); color: #383d47; padding: 0.5rem 1rem; border-radius: 8px; font-size: 1.2rem; border: 1px solid #5dc4af;">
                      ${g.ges}
                    </span>
                  `)}
                </div>
              </div>
            ` : ''}
          </div>
        `)}
      </div>

      <div class="wizard-hint" style="margin-top: 3rem;">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm1 15H9v-2h2v2zm0-4H9V5h2v6z"/>
        </svg>
        <span>
          Al finalizar se generar√°n autom√°ticamente: Matriz de Riesgos, Profesiograma y Perfiles de Cargo.
        </span>
      </div>
    `;
  },

  validate: () => ({ isValid: true, errors: [] })
};

// =================================================================
// FUNCI√ìN HELPER: GENERAR PASOS DIN√ÅMICAMENTE
// =================================================================

/**
 * Genera todos los pasos del wizard basado en el n√∫mero de cargos
 * @param {number} numCargos - N√∫mero de cargos a evaluar
 * @returns {Array} Array de pasos del wizard
 */
export function generateWizardSteps(numCargos) {
  const steps = [
    welcomeStep,
    empresaStep,
    numCargosStep
  ];

  for (let i = 0; i < numCargos; i++) {
    // Info del cargo
    steps.push(createCargoInfoStep(i, numCargos));

    // Nota: Los pasos de GES y controles se agregar√°n din√°micamente
    // despu√©s de que el usuario complete cada cargo, ya que dependen
    // de cu√°ntos GES seleccione
  }

  steps.push(reviewStep);

  return steps;
}

/**
 * Genera pasos adicionales para GES y controles despu√©s de seleccionar GES
 * @param {number} cargoIndex - √çndice del cargo
 * @param {Array} gesSeleccionados - Array de GES seleccionados
 * @param {string} cargoName - Nombre del cargo
 * @returns {Array} Array de pasos adicionales
 */
export function generateGESControlSteps(cargoIndex, gesSeleccionados, cargoName) {
  const steps = [];

  gesSeleccionados.forEach((ges, gesIndex) => {
    steps.push(
      createControlesStep(cargoIndex, gesIndex, cargoName, ges.riesgo, ges.ges)
    );
  });

  return steps;
}
